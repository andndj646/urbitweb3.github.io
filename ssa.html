<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LibreSeek Â· è‡ªç”±æœ</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: auto; background: #f8fafc; }
    .error { background: #fee; border-left: 4px solid #f87171; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0; }
    .success { background: #eff6ff; border-left: 4px solid #60a5fa; padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0; }
    .btn { background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
    #results { margin-top: 20px; }
    .site { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>LibreSeek Â· è‡ªç”±æœ</h1>
  
  <div id="status"></div>
  <button class="btn" onclick="loadData()">ğŸ”„ é‡æ–°åŠ è½½æ•°æ®</button>
  <button class="btn" onclick="openGistEdit()">âœï¸ ç¼–è¾‘ç½‘ç«™åˆ—è¡¨</button>

  <div id="results"></div>

  <script>
    // === ä½ çš„ Gist é…ç½® ===
    const USERNAME = "andndj646";
    const GIST_ID = "ed9d56cff1b2f3e16a730561a3b4fc4f";
    const RAW_URL = `https://gist.githubusercontent.com/${USERNAME}/${GIST_ID}/raw/data.json`;
    const EDIT_URL = `https://gist.github.com/${USERNAME}/${GIST_ID}#file-data-json`;

    function showStatus(msg, isError = false) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = isError ? 'error' : 'success';
      statusDiv.innerHTML = `
        <strong>${isError ? 'âŒ é”™è¯¯' : 'â„¹ï¸ ä¿¡æ¯'}</strong><br>
        ${msg}
        ${isError ? '<br><br>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ä¿®å¤ï¼š<ol><li>ç¡®ä¿ Gist æ˜¯ <strong>Public</strong></li><li>æ–‡ä»¶åå¿…é¡»æ˜¯ <code>data.json</code></li><li>æµ‹è¯• Raw é“¾æ¥ï¼š<a href="' + RAW_URL + '" target="_blank">ç‚¹å‡»è¿™é‡Œ</a></li></ol>' : ''}
      `;
    }

    async function loadData() {
      try {
        showStatus('æ­£åœ¨åŠ è½½æ•°æ®...');
        
        // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ï¼ˆåŠ æ—¶é—´æˆ³ï¼‰
        const cacheBuster = `${RAW_URL}?t=${Date.now()}`;
        const res = await fetch(cacheBuster);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼ï¼ˆå¯èƒ½æ˜¯ HTML é¡µé¢ï¼‰');
        }
        
        const sites = await res.json();
        renderSites(sites);
        showStatus(`æˆåŠŸåŠ è½½ ${sites.length} ä¸ªç½‘ç«™`, false);
      } catch (err) {
        console.error('Fetch error:', err);
        let errMsg = err.message;
        
        if (errMsg.includes('Failed to fetch')) {
          errMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚å¯èƒ½åŸå› ï¼š<br>- Gist æ˜¯ Secretï¼ˆéå…¬å¼€ï¼‰<br>- æ–‡ä»¶åä¸æ˜¯ data.json<br>- æµè§ˆå™¨æ’ä»¶ï¼ˆå¦‚å¹¿å‘Šæ‹¦æˆªå™¨ï¼‰é˜»æ­¢äº†è¯·æ±‚';
        } else if (errMsg.includes('Unexpected token')) {
          errMsg = 'JSON æ ¼å¼é”™è¯¯ã€‚è¯·æ£€æŸ¥ data.json å†…å®¹æ˜¯å¦ä¸ºæœ‰æ•ˆ JSON';
        }
        
        showStatus(errMsg, true);
      }
    }

    function renderSites(sites) {
      const container = document.getElementById('results');
      if (sites.length === 0) {
        container.innerHTML = '<p>æš‚æ— ç½‘ç«™ã€‚ç‚¹å‡»â€œç¼–è¾‘ç½‘ç«™åˆ—è¡¨â€æ·»åŠ ï¼</p>';
        return;
      }
      container.innerHTML = sites.map(site => `
        <div class="site">
          <h3><a href="${site.url}" target="_blank">${site.title || site.title_en || 'Untitled'}</a></h3>
          <p>${site.description || site.description_en || ''}</p>
          <small>${site.url} â€¢ ${site.type === 'i2p' ? 'I2P' : 'Clearnet'}</small>
        </div>
      `).join('');
    }

    function openGistEdit() {
      window.open(EDIT_URL, '_blank');
    }

    // åˆå§‹åŠ è½½
    loadData();
  </script>
</body>
</html>
