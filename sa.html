<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LibreSeek · 自由搜</title>
  <style>
    :root { --bg: #f9fafb; --text: #1f2937; --card-bg: #fff; --border: #e5e7eb; --primary: #4f46e5; }
    [data-theme="dark"] { --bg: #111827; --text: #f3f4f6; --card-bg: #1f2937; --border: #374151; }
    * { margin:0; padding:0; box-sizing:border-box; font-family: system-ui; }
    body { background:var(--bg); color:var(--text); padding:20px; line-height:1.6; }
    .container { max-width:800px; margin:auto; }
    header { text-align:center; margin:30px 0; }
    h1 { font-size:2.2rem; background:linear-gradient(90deg,#8b5cf6,#10b981); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .btn { background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin:10px 5px; }
    .form-group { margin:15px 0; }
    label { display:block; margin-bottom:5px; font-weight:bold; }
    input, textarea, select { width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--card-bg); color:var(--text); }
    .result { background:var(--card-bg); border:1px solid var(--border); border-radius:10px; padding:15px; margin:15px 0; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:var(--card-bg); padding:25px; border-radius:12px; width:90%; max-width:600px; }
    .close { float:right; font-size:1.5rem; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>LibreSeek · 自由搜</h1>
      <p>抗审查的明网与 I2P 网站目录</p>
    </header>

    <button class="btn" id="addBtn">➕ 新增网站</button>

    <div id="results"></div>
  </div>

  <!-- 新增网站表单（模态框） -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>新增网站</h3>
      <div class="form-group">
        <label>标题（中文）</label>
        <input id="title_zh" placeholder="例如：自由新闻">
      </div>
      <div class="form-group">
        <label>Title (English)</label>
        <input id="title_en" placeholder="e.g. Free Press">
      </div>
      <div class="form-group">
        <label>网址 URL</label>
        <input id="url" placeholder="http://example.i2p 或 https://example.com">
      </div>
      <div class="form-group">
        <label>类型</label>
        <select id="type">
          <option value="clearnet">明网 (Clearnet)</option>
          <option value="i2p">I2P 暗网</option>
        </select>
      </div>
      <div class="form-group">
        <label>描述（中文）</label>
        <textarea id="desc_zh" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label>Description (English)</label>
        <textarea id="desc_en" rows="2"></textarea>
      </div>
      <button class="btn" id="submitForm">下一步：提交到 Gist</button>
    </div>
  </div>

  <script>
    // === 配置你的 Gist ===
    const GIST_ID = "andndj646/4623c211338a317b1e8c68b07d5b0853";
    const USERNAME = "andndj646";
    const RAW_URL = `https://gist.github.com/andndj646/4623c211338a317b1e8c68b07d5b0853/raw/data.json`;
    const EDIT_URL = `https://gist.github.com/andndj646/4623c211338a317b1e8c68b07d5b0853/edit`;

    // 加载数据
    async function loadSites() {
      try {
        const res = await fetch(RAW_URL);
        if (!res.ok) throw new Error("Gist 未公开或文件不存在");
        const sites = await res.json();
        renderSites(sites);
      } catch (err) {
        document.getElementById('results').innerHTML = `<div style="color:red; text-align:center;">❌ 加载失败：<br>${err.message}<br><br>请确保 Gist 公开且文件名为 data.json</div>`;
      }
    }

    function renderSites(sites) {
      const container = document.getElementById('results');
      container.innerHTML = sites.map(site => `
        <div class="result">
          <h3><a href="${site.url}" target="_blank">${site.title || site.title_en}</a></h3>
          <p>${site.description || site.description_en || ''}</p>
          <small>${site.url} • ${site.type === 'i2p' ? 'I2P' : 'Clearnet'}</small>
        </div>
      `).join('');
    }

    // 弹窗逻辑
    document.getElementById('addBtn').onclick = () => {
      document.getElementById('modal').style.display = 'flex';
    };
    document.querySelector('.close').onclick = () => {
      document.getElementById('modal').style.display = 'none';
    };
    window.onclick = (e) => {
      if (e.target.id === 'modal') document.getElementById('modal').style.display = 'none';
    };

    // 提交表单：生成 JSON 并跳转到 Gist 编辑页
    document.getElementById('submitForm').onclick = () => {
      const site = {
        title: document.getElementById('title_zh').value.trim(),
        title_en: document.getElementById('title_en').value.trim(),
        url: document.getElementById('url').value.trim(),
        type: document.getElementById('type').value,
        description: document.getElementById('desc_zh').value.trim(),
        description_en: document.getElementById('desc_en').value.trim(),
        tags: [],
        rating: 0,
        comments: []
      };

      if (!site.url) { alert("请输入网址"); return; }

      // 获取当前数据（用于合并）
      fetch(RAW_URL)
        .then(res => res.json())
        .catch(() => [])
        .then(existing => {
          const allSites = [...existing, site];
          const jsonStr = JSON.stringify(allSites, null, 2);
          const blob = new Blob([jsonStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          // 提示用户复制内容并粘贴到 Gist
          alert("即将跳转到 Gist 编辑页。\n请将下方 JSON 内容全选、复制，然后粘贴到 Gist 的 data.json 中，最后点击 Update gist。");

          // 打开新标签页显示 JSON（方便复制）
          window.open(url, '_blank');

          // 跳转到 Gist 编辑页
          setTimeout(() => {
            window.open(EDIT_URL, '_blank');
          }, 1000);
        });
    };

    // 初始化
    loadSites();
  </script>
</body>
</html>
